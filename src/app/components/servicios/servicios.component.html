<div class="card">
    <p-menubar [model]="items"></p-menubar>
</div>
<div *ngIf="router.url === '/principal/servicios'" class="tableServices">
    <p-card>
        <div class="p-inputgroup mb-3" style="max-width: 300px; ">
            <span class="p-inputgroup-addon"><i class="pi pi-search"></i></span>
            <input type="text" pInputText placeholder="Buscar servicio por folio " (input)="applyFilterGlobal($event, dtServicio)">
        </div>
        <p-table [value]="servicios" [tableStyle]="{ 'min-width': '60rem' }"
        #dtServicio dataKey="id" [loading]="loading" [globalFilterFields]="['folioServicio']" [paginator]="true" [rows]="5">
            <ng-template pTemplate="caption">
                <div class="flex align-items-center justify-content-between">
                    Servicios
                </div>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th>Folio</th>
                    <th>Ubicación de salida</th>
                    <th>Ubicación de contacto</th>
                    <th>Ubicación de termino</th>
                    <th>Estatus</th>
                    <th>Editar</th>
                    <th>Datos Servicio</th>
                    <th>Enviar Carta</th>
                     <th>Carta Porte</th>
                     <th>Finalizar</th>


                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-servicio>
                <tr>
                    <td>{{ servicio?.folioServicio }}</td>
                    <td>{{ servicio?.ubicacionSalida }}</td>
                    <td>{{ servicio?.ubicacionContacto }}</td>
                    <td>{{ servicio?.ubicacionTermino }}</td>
                    <td>
                        <p-tag [value]="servicio?.estadoServicio" [severity]="getSeverity(servicio?.estadoServicio)"></p-tag>
                    </td>
                    <td>
                        <div class="flex">
                            <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-warning mr-2"
                                (click)="editServicio(servicio)"></button>
                        </div>
                    </td>
                    <td>
                        <div class="flex">
                            <button pButton pRipple icon="pi pi-whatsapp" class="p-button-rounded p-button-success mr-2"
                              (click)="enviarMensaje(servicio)" ></button>
                        </div>
                    </td>
                    <td>
                        <div class="flex">
                            <button pButton pRipple icon="pi pi-whatsapp" class="p-button-rounded p-button-success mr-2"
                              (click)="enviarMensajeOperador(servicio)" ></button>
                        </div>
                    </td>
                    <td>
                        <div class="flex">
                            <button pButton pRipple icon="pi pi-download" class="p-button-rounded p-button-success mr-2"
                            [ngStyle]="{backgroundColor:'var(--teal-500)'}"   (click)="generarCartaPorte(servicio)" ></button>
                        </div>
                    </td>
                    <td>
                        <div class="flex">
                            <button pButton pRipple icon="pi pi-check" class="p-button-rounded p-button-primary mr-2"
                                (click)="confirmFinishServicio(servicio)"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="summary">
                <div class="flex align-items-center justify-content-between">

                </div>
            </ng-template>
        </p-table>
    </p-card>
</div>
<p-toast position="top-center"></p-toast>


<p-dialog [(visible)]="updateDialog" [style]="{ width: '900px' }" header="Editar servicio" [modal]="true"
    class="p-fluid">
    <ng-template pTemplate="content">
        <p-accordion [activeIndex]="0">
            <p-accordionTab header="Datos del cliente">
                <div class="car">
                    <form [formGroup]="clientForm" class="p-formgrid">
                        <div class="p-field">
                            <label for="numTe">Número de teléfono</label>
                            <p-inputNumber id="numTe" formControlName="numTelefono" [maxlength]="10"
                                [(ngModel)]="servEdit?.cliente.numTelefono" [minlength]="10"
                                [useGrouping]="false"></p-inputNumber>
                        </div>
                        <div class="p-field">
                            <label for="cliente">Seleccione el cliente</label>
                            <p-dropdown [options]="clientes" optionLabel="nombreCliente" formControlName="clienteTipo"
                                placeholder="Seleccione" [editable]="true" [(ngModel)]="servEdit?.cliente.clienteTipo">
                            </p-dropdown>
                        </div>

                    </form>
                </div>
                <div class="custom-button">
                    <p-button label="Actualizar" icon="pi pi-check" styleClass="custom-button"
                        (onClick)="updateCliente()" [disabled]="enaClien"></p-button>
                </div>


            </p-accordionTab>
            <p-accordionTab header="Datos del vehículo">
                <div class="car">
                    <form [formGroup]="vehicleForm" class="p-formgrid">
                        <div class="p-field">
                            <label for="tipoV">Tipo de vehículo</label>
                            <p-dropdown [options]="tiposVehiculo" placeholder="Selecciona" optionLabel="nombre"
                                formControlName="tipoVehiculo" [editable]="true"
                                [(ngModel)]="servEdit?.vehiculo.tipoVehiculo">
                            </p-dropdown>
                        </div>
                        <div class="p-field">
                            <label for="marca">Marca</label>
                            <p-dropdown placeholder="Selecciona una Marca" [options]="marcas" optionLabel="nombre"
                                (onChange)="filtrarModelosPorMarca()" formControlName="marca" [editable]="true"
                                [(ngModel)]="selectedMarca">
                            </p-dropdown>
                        </div>
                        <div class="p-field">
                            <label for="modelo">Modelo</label>
                            <p-dropdown placeholder="Selecciona un Modelo" [options]="modelosFiltrados"
                                optionLabel="nombre" formControlName="modelo" [editable]="true"
                                [(ngModel)]="selectedModelo">
                            </p-dropdown>

                        </div>
                        <div class="p-field">

                            <label for="placas">Placas</label>
                            <input type="text" pInputText id="placas" formControlName="placas" required
                                [(ngModel)]="servEdit?.vehiculo.placas"  minlength="6" maxlength="7"/>
                        </div>
                        <div class="p-field">
                            <label for="serie">Serie</label>
                            <input type="email" pInputText id="serie" formControlName="serie" required
                                [(ngModel)]="servEdit?.vehiculo.serie" minlength="17" maxlength="17" pKeyFilter="alphanum" />
                        </div>
                        <div class="p-field">
                            <label for="color">Color</label>
                            <input type="text" pInputText id="color" formControlName="color"
                                [(ngModel)]="servEdit?.vehiculo.color"  minlength="3" maxlength="10" pKeyFilter="alpha"/>
                        </div>
                        <div class="p-field">
                            <label for="ano">Año</label>
                            <p-inputNumber id="ano" formControlName="ano" [maxlength]="4"
                                [(ngModel)]="servEdit?.vehiculo.ano" [minlength]="4"
                                [useGrouping]="false"></p-inputNumber>

                        </div>
                        <div class="p-field">
                            <label for="poliza">No Poliza</label>
                            <input type="text" pInputText id="serie" formControlName="poliza" required
                                [(ngModel)]="servEdit?.vehiculo.poliza" minlength="8" maxlength="10" pKeyFilter="int" />
                        </div>
                       
                    </form>

                </div>
                <div class="custom-button">
                    <p-button label="Actualizar" icon="pi pi-check" [disabled]="!vehicleForm.valid"
                        styleClass="custom-button" (onClick)="updateVehiculo()" [disabled]="enaVehi"></p-button>


                </div>

            </p-accordionTab>
            <p-accordionTab header="Datos del servicio">
                <div class="car">
                    <form [formGroup]="servicioForm" class="p-formgrid">
                        <div class="p-field">
                            <label for="ubiSalida">Ubicación de salida</label>
                            <input type="text" pInputText id="ubiSalida" formControlName="ubicacionSalida" required
                                [(ngModel)]="editingServicio.ubicacionSalida"  minlength="2" maxlength="22" />
                        </div>
                        <div class="p-field">
                            <label for="ubiContact">Ubicación de contacto</label>
                            <input type="text" pInputText id="ubiContact" formControlName="ubicacionContacto"
                                [(ngModel)]="editingServicio.ubicacionContacto" required   minlength="2" maxlength="22"/>
                        </div>
                        <div class="p-field">
                            <label for="ubiTermino">Ubicación de termino</label>
                            <input type="text" pInputText id="ano" formControlName="ubicacionTermino" required
                                [(ngModel)]="editingServicio.ubicacionTermino"  minlength="2" maxlength="22"/>
                        </div>
                        <div class="p-field">
                            <label for="monto">Monto cobrado</label>
                            <input type="number" pInputText id="monto" formControlName="montoCobrado" 
                                [(ngModel)]="editingServicio.montoCobrado" />
                        </div>
                        <div class="p-field">
                            <label for="operador">Seleccione el operador</label>
                            <p-dropdown [options]="operadores" optionLabel="nombre" placeholder="Seleccione"
                                formControlName="operador" [editable]="true" [(ngModel)]="editingServicio.operador">
                            </p-dropdown>
                        </div>
                        <div class="p-field">
                            <label for="grua">Seleccione la grúa</label>
                            <p-dropdown [options]="gruas" optionLabel="noEco" formControlName="grua"
                                placeholder="Seleccione" [editable]="true" [(ngModel)]="editingServicio.grua">
                            </p-dropdown>
                        </div>
                        <div class="p-field">
                            <label for="observaciones">Observaciones</label>
                            <textarea id="observaciones" pInputTextarea formControlName="observaciones" rows="2"
                                [(ngModel)]="editingServicio.observaciones" cols="50"></textarea>
                        </div>
                    </form>
                </div>
                <div class="custom-button">
                    <p-button label="Actualizar" icon="pi pi-check" [disabled]="!servicioForm.valid"
                        styleClass="custom-button" (onClick)="updateService()" [disabled]="enaSer"></p-button>


                </div>

            </p-accordionTab>
        </p-accordion>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text"
            (click)="updateDialog = false"></button>


    </ng-template>
</p-dialog>

<p-dialog [(visible)]="deleteServicioDialog" header="Confirmación" [modal]="true" [style]="{width:'450px'}">
    <div class="flex align-items-center justify-content-center">
        <span *ngIf="servicioFinalizado">Está seguro que quiere finalizar el servicio ?</span>
    </div>
    <div class="flex flex-column align-items-center justify-content-center mt-4">
        <label for="salida" class="mb-2">Kilometraje de termino de la grua</label>
        <p-inputNumber id="salida" [(ngModel)]="kilometrajeTermino" [maxlength]="6" [minlength]="3" [useGrouping]="false"></p-inputNumber>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple icon="pi pi-times" class="p-button-text" label="No" (click)="deleteServicioDialog = false"></button>
        <button pButton pRipple icon="pi pi-check" class="p-button-text" label="Si" [disabled]="kilometrajeTermino === null" (click)="finServicio()"></button>
    </ng-template>
</p-dialog>



<p-dialog [(visible)]="confirmMessageDialog" header="Confirmación" [modal]="true" [style]="{width:'450px'}">
    <div class="flex flex-column align-items-center justify-content-center">
        <div class="iconDelete">
            <i class="pi pi-exclamation-triangle " style="font-size: 2rem"></i>
        </div>
        <span >Está seguro de continuar ?</span>

    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple icon="pi pi-times" class="p-button-text" label="No"
            (click)="confirmMessageDialog = false"></button>
        <button pButton pRipple icon="pi pi-check" class="p-button-text" label="Si"
            (click)="confirmMessage()"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="confirmCartaDialog" header="Confirmación" [modal]="true" [style]="{width:'450px'}">
    <div class="flex flex-column align-items-center justify-content-center">
        <div class="iconDelete">
            <i class="pi pi-exclamation-triangle " style="font-size: 2rem"></i>
        </div>
        <span >Está seguro de continuar ?</span>

    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple icon="pi pi-times" class="p-button-text" label="No"
            (click)="confirmCartaDialog = false"></button>
        <button pButton pRipple icon="pi pi-check" class="p-button-text" label="Si"
            (click)="confirmMessageCarta()"></button>
    </ng-template>
</p-dialog>

<router-outlet></router-outlet>